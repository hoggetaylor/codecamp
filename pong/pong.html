<html>
    <head>
        <title>PONG</title>
        <style>

            html, body {
                margin: 0px;
                padding: 0px;
                width: 100%;
            }

            .title {
                margin-top: 50px;
                text-align: center;
            }

            
            

            canvas {
                margin-top: 50px;
                padding-left: 0;
                padding-right: 0;
                margin-left: auto;
                margin-right: auto;
                display: block;
                background-color: black;
                display:line;
                background-color: black;
            }
            
        </style>
    </head>
    <body>
        <div class="title">
            <h1>PONG</h1>
           
        </div>
        <canvas width="900" height="500" id="gameCanvas"></canvas>
        <line width="10" height="500" id="line"></line>
        <script type="text/javascript">

            // If this variable is true, it means the user is currently pressing down the 'w' key.
            let wPressed = false;
            // If this variable is true, it means that the user is currently pressing down the 's' key.
            let sPressed = false;
            // If this variable is true, it means that the user is currently pressing down the up arrow.
            let upPressed = false;
            // If this variable is true, it means that the user is currently pressing down the down arrow.
            let downPressed = false;
            // If this variable is true, it means that the space bar is currently being pressed down.
            let spacePressed = false;
            let escapepresed = false;
            // This varifaable holds the current background color of the canvas.
            let backgroundColor = 'black';
            // These objects hold the state of each player.
            // Notice that y is 225 because it equals (canvas.height / 2) - (player.height / 2)
            let player1 = { x: 10, y: 225, width: 10, height: 50, score:0, xVelocity: 0, yVelocity: 0 };
            let player2 = { x: 880, y: 225, width: 10, height: 50, score: 0, xVelocity: 0, yVelocity: 0 };
            // This object holds the state of the ball.
            let ball = { x: 445, y: 245, width: 10, height: 10, waiting: true, xVelocity: 0, yVelocity: 0 };
            // This variable holds a reference to the canvas that lives within the html document.
            let canvas = document.getElementById('gameCanvas');
            let line = document.getElementById('line');
          
            // When the page loads...ne
                        window.onload = function() {
                // Listen for keydown events
                document.onkeydown = function (keyEvent) {
                    keyEvent.preventDefault();
                    // If the key that went down was the 'w' key...
                    if (keyEvent.key === 'w') {
                        // Set the wPressed variable to true
                        wPressed = true;
                        player1.yVelocity = -200;
                    // Else, if the key that went down was the 's' key...
                    } else if (keyEvent.key === 's') {
                        // Set the sPressed variable to true
                        sPressed = true;
                        player1.yVelocity = 200;
                    } else if (keyEvent.key === 'ArrowUp') {
                        upPressed = true;
                        player2.yVelocity = -200;
                    } else if (keyEvent.key === 'ArrowDown') {
                        player2.yVelocity = 200;
                        downPressed = true;
                    } else if (keyEvent.key === ' ') {
                        spacePressed = true;
                    } else if (keyEvent.key ==='Escape'){
                        escapepresed = true
                    }
                }     
                // Listen for keyup events
                document.onkeyup = function (keyEvent) {
                    keyEvent.preventDefault();
                    // If the key that went up was the 'w' key...
                    if (keyEvent.key === 'w') {
                        // Set the wPressed variable back to false
                        wPressed = false;
                        player1.yVelocity = 0;
                    // Else, if the key that went up was the 's' key...
                    } else if (keyEvent.key === 's') {
                        // Set the sPressed variable back to false
                        player1.yVelocity = 0;
                        sPressed = false;
                    } if (keyEvent.key === 'ArrowUp') {
                        upPressed = false;
                        player2.yVelocity = 0;
                    } else if (keyEvent.key === 'ArrowDown') {
                        downPressed = false;
                        player2.yVelocity = 0;
                    } else if (keyEvent.key === ' ') {
                        spacePressed = false;
                    } else if (keyEvent.key === 'Escape') {
                        escapepresed= false;
                    }
                }

                // Start the game loop
                // This asks the browser to call the update function
                // every 16 milliseconds.
                setInterval(update, 16);
            }

            // Runs one iteration of the game loop
            function update() {
                console.log('Game loop is executing.');
                // We start the game loop by modifying the current game state
                // based on the current input from the user
                checkUserInput();
                // After responding to user input, we update the physics by
                // moving any objects by their velocity and checking for collisions.
                updatePhysics();
                // After physics have been updated, we check to see if either player
                // has scored a point.
                updateScore();
                // We end the game loop by rendering the current state of the game
                // to the canvas.
                render();
            }

            // Modifies the game state based on the current user input
            function checkUserInput() {
                console.log('Checking user input.');
                if (escapepresed){
                    ball = { x: 445, y: 245, width: 10, height: 10, waiting: true, xVelocity: 0, yVelocity: 0 };
                    player1.score = 0
                    player2.score = 0
                }
                
                // If the ball is currently waiting to start moving
                // and the spacebar is currently pressed...
                if (ball.waiting && spacePressed) {
                    // Assign the ball a random velocity on both the x and y axis.
                    ball.waiting = false;
                    ball.xVelocity = randomNegation() * randomBetween(100, 150);
                    ball.yVelocity = randomNegation() * randomBetween(0, 125);
                }
            }

            // This function simulates the physics of the dynamic objects (ie the ball)
            function updatePhysics() {

                bounce(player1, ball);
                bounce(player2, ball);

                // Move the player's by their velocity
                player1.x += (player1.xVelocity / 60);
                player1.y += (player1.yVelocity / 60);
                if (player1.y < 0) {
                    player1.y = 0;
                } else if (player1.y + player1.height > canvas.height) {
                    player1.y = canvas.height - player1.height;
                }

                player2.x += (player2.xVelocity / 60);
                player2.y += (player2.yVelocity / 60);
                if (player2.y <0) {
                    player2.y =  0;
                } else if (player2.y + player2.height > canvas.height) {
                    player2.y = canvas.height - player2.height;
                }

                // Move the ball .s on it's velocity (in pixels per second)
                ball.x += (ball.xVelocity / 60);
                ball.y += (ball.yVelocity / 60);

                // Check to see if the ball has hit the bottom of the canvas
                if (ball.y + ball.height >= 500) {
                    // The ball needs to bounce upwards
                    ball.y = 500 - ball.height;
                    ball.yVelocity *= -1;
                }

                if (ball.y <= 0){
                    ball.y = 0 ;
                    ball.yVelocity *= -1;
                }           
            }
            

            function updateScore() {
                if (ball.x <= 0) {
                    // The ball  has reached the left side of the canvas.
                    // Move the ball back into the center and make it wait
                    ball = { x: 445, y: 245, width: 10, height: 10, waiting: true, xVelocity: 0, yVelocity: 0 };
                    // Increase player2's score.
                    player2.score += 1;
                } if (ball.x >= 900) {
                    ball = { x: 445, y: 245, width: 10, height: 10, waiting: true, xVelocity: 0, yVelocity: 0 };
                    player1.score += 1;
                }
            } 

            // Renders the current state of the game to the canvas
            function render() {
                console.log('Rendering');
                let ctx = canvas.getContext('2d');

                // Draw the background
                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Render player1
                ctx.fillStyle = 'white';
                ctx.fillRect(player1.x, player1.y, player1.width, player1.height);
                ctx.fillRect(player2.x, player2.y, player2.width, player2.height);
                ctx.fillRect(ball.x, ball.y, ball.width, ball.height);
                ctx.beginPath();       // Start a new path
                ctx.moveTo(450, 500);    // Move the pen to (30, 50)
                ctx.lineTo(450, 0);  // Draw a line to (150, 100)
                ctx.lineWidth = 3
                ctx.strokeStyle = "white"
                ctx.stroke();          // Render the path
                // Render score
                const mid=canvas.width/2
                ctx.font="32px sans-serif"
                ctx.fillText( player2.score.toString(),mid + mid /2,28);
                ctx.fillText(player1.score.toString(),mid - mid/2,28);
            }  

            // Randomly return 1 or -1
            function randomNegation() {
                if (Math.random() >= 0.5) {
                    return 1
                } else {
                    return -1;
                }
            }

            // Random number between min and max
            function randomBetween(min, max) {
                return min + (Math.random() * (max - min));
            }

            function bounce(player, ball) {
                const xOverlap = overlapsOnXAxis(player, ball);
                const yOverlap = overlapsOnYAxis(player, ball);
                if (xOverlap > 0 && yOverlap > 0) {
                    // player and ball are intersecting
                    if (xOverlap <= yOverlap) {
                        // bounce on the x axis
                        ball.yVelocity = (ball.yVelocity + player.yVelocity) / 2;
                        ball.xVelocity = ball.xVelocity * -1;
                        ball.x += xOverlap;
                    } else {
                        // bounce on the y axis
                        ball.yVelocity = ball.yVelocity * -1;
                        ball.yVelocity += yOverlap;
                    }
                }
            }

            function overlapsOnXAxis(rect1, rect2) {
                let start1 = rect1.x;
                let end1 = rect1.x + rect1.width;
                let start2 = rect2.x;
                let end2 = rect2.x + rect2.width;
                return overlapsOnNumberLine(start1, end1, start2, end2);
            }

            function overlapsOnYAxis(rect1, rect2) {
                let start1 = rect1.y;
                let end1 = rect1.y + rect1.height;
                let start2 = rect2.y;
                let end2 = rect2.y + rect2.height;
                return overlapsOnNumberLine(start1, end1, start2, end2);
            }

            // Returns a positive number if there is an overlap
            // Negative number if there is no overlap
            function overlapsOnNumberLine(start1, end1, start2, end2) {
                let maxStart = Math.max(start1, start2);
                let minEnd = Math.min(end1, end2);
                return minEnd - maxStart;
            }

        </script>

    </body>
</html>