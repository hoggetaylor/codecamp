<!DOCTYPE html>
<html>
    <head>
        <title>Asteroids!</title>
    </head>
    <body>
        <canvas width="800" height="600" id="canvas" style="margin: auto; display: block; margin-top: 50px"></canvas>

        <script type="text/javascript">

            // Monitor which keys are currently pressed.
            const pressedKeys = new Set();
            document.onkeydown = (e) => {
                e.preventDefault (); 
                pressedKeys.add(e.key);
            }
            document.onkeyup = (e) =>  {
                e.preventDefault (); 
                pressedKeys.delete(e.key);
            }

            const clickedmouse = new Set();
            document.onmousedown =(e) => {
                clickedmouse.add(e.button)
            }
            document.onmouseup = (e) => {
                clickedmouse.delete(e.button)
            }

            const PLAYER_WIDTH = 15;
            const PLAYER_HEIGHT = 20;
            const PLAYER_ROTATION_DEGREES_PER_SECOND = 200;
            const PLAYER_ACCELERATION = 105;
            const PLAYER_MAXVELOCITY = 100
            const DT = 16.0 / 1000.0;

            const canvas = document.getElementById('canvas');
            const player = makePlayer();
            let asteroids = []
            let asteroidtimer = 0.5;
            let gametimer = 0
            let gameover = false
            let bullets = []
            let bullettimer = 0
            let particles = []
            
            

            setInterval(update, 16);

            function update() {
                updateUserInput();
                updateAsteroidsTimer();
                updatePhysics();
                updateParticles();
                render();
                if(!gameover){
                gametimer += DT
                bullettimer -= DT
                }
            
            }
            function updateAsteroidsTimer() {
                asteroidtimer -= DT
                if (asteroidtimer <= 0) {
                    makeAsteroid ()
                    asteroidtimer = 1
                }
            }

            function updateUserInput() {
                const rotationDelta = PLAYER_ROTATION_DEGREES_PER_SECOND * DT;
                if (pressedKeys.has('ArrowLeft') || pressedKeys.has('a')) {
                    player.rotation -= rotationDelta;
                }
                if (pressedKeys.has('ArrowRight') || pressedKeys.has('d')) {
                    player.rotation += rotationDelta;
                } 
                if (player.rotation > 360) { player.rotation = player.rotation % 360; }
                if (player.rotation < 0) { player.rotation = 360 - player.rotation; }
                if (pressedKeys.has('ArrowUp') || pressedKeys.has('w')) {
                    player.yAcceleration = Math.cos(rad(player.rotation)) * PLAYER_ACCELERATION * -1;
                    player.xAcceleration = Math.sin(rad(player.rotation)) * PLAYER_ACCELERATION;
                    spawnParticle(player.x,player.y,1)
                } else {
                   player.yAcceleration = 0 
                   player.xAcceleration = 0
                }
                if (pressedKeys.has(' ')||clickedmouse.has(0)){
                    SpawnBullet(player.x,player.y,player.rotation)
                }       
            }

            function updatePhysics() {
                enactMotion(player,PLAYER_MAXVELOCITY)
                
                for (const asteroid of asteroids) {
                    enactMotion(asteroid,PLAYER_MAXVELOCITY)
                    if (iswithincanvas(asteroid)) {
                        asteroid.isvisible=true
                     }
                     else {
                        if (asteroid.isvisible) {
                            asteroid.delete=true
                        }
                     }
                     if(intersects(player,asteroid)){
                        gameover = true
                     }

                }
                asteroids=asteroids.filter(a => !a.delete)
                console.log(asteroids.length)

                for (const bullet of bullets){
                    enactMotion(bullet,200)
                    bullet.delete=!iswithincanvas(bullet)
                    for (const asteroid of asteroids){
                        if (intersects(bullet,asteroid)){
                            bullet.delete=true
                            asteroid.delete=true

                        }
                    }
                    
                }
                    bullets = bullets.filter(b =>!b.delete)
                    asteroids=asteroids.filter(a => !a.delete)

                if (player.x < 0) {
                     player.x = canvas.width
                }
                if (player.y < 0){
                    player.y = canvas.height
                }
                if (player.x > canvas.width) {
                    player.x = 0
                }
                if (player.y > canvas.height) {
                    player.y = 0
                }
                
            }

            function iswithincanvas(asteroid){
                if (asteroid.x + asteroid.radius < 0) {
                    return false 
                }
                if (asteroid.x - asteroid.radius > canvas.width) {
                    return false
                }
                if (asteroid.y + asteroid.radius < 0) {
                    return false
                }
                if (asteroid.y - asteroid.radius > canvas.height) {
                    return false
                }
                return true 

            }
 
            function enactMotion(entity,maxvelocity) {
                entity.xVelocity += (entity.xAcceleration || 0 )  * DT;
                entity.yVelocity += (entity.yAcceleration || 0 ) * DT;
                entity.xVelocity = Math.min(entity.xVelocity,maxvelocity)
                entity.yVelocity = Math.min(entity.yVelocity,maxvelocity)
                entity.x += entity.xVelocity * DT;
                entity.y += entity.yVelocity * DT;
            }

            function render() {
                const ctx = canvas.getContext('2d')
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle ='white'
                ctx.font = '50px sans-serif'
                ctx.textAlign = 'left';
                ctx.fillText (gametimer.toFixed(2),10,60)
                if(gameover){
                    ctx.textAlign = 'center';
                    ctx.fillText ('Game Over',canvas.width/2,canvas.height/2)
                }
                ctx.strokeStyle = 'white';
                ctx.strokeWidth = 2;
                if(!gameover){
                    //ctx.beginPath()
                    //ctx.arc(player.x, player.y, player.radius, 0,Math.PI*2)
                    //ctx.stroke()

                    ctx.save();
	                ctx.translate(player.x, player.y);
	                ctx.rotate(rad(player.rotation));
	                ctx.beginPath();
	                ctx.moveTo(0, -1 * PLAYER_WIDTH);
	                ctx.lineTo(PLAYER_WIDTH, PLAYER_WIDTH);
	                ctx.lineTo(-1 * PLAYER_WIDTH, PLAYER_WIDTH);
	                ctx.lineTo(0, -1 * PLAYER_WIDTH);
	                ctx.stroke();
	                ctx.closePath();
	                ctx.restore();
                }
                for (const bullet of bullets) {
                    ctx.beginPath()
                    ctx.arc(bullet.x, bullet.y, bullet.radius, 0,Math.PI*2)
                    ctx.stroke()
                }
                for(const asteroid of asteroids) {
                    ctx.beginPath()
                    ctx.arc(asteroid.x, asteroid.y, asteroid.radius, 0,Math.PI*2)
                    ctx.stroke()
                }
                for (const particle of particles) {
                    ctx.fillStyle = "rgba(255, 255, 255, 0.5)"
                    ctx.fillRect(particle.x,particle.y,1,1)
                }
            }

            function makePlayer() {
                return {
                   radius:PLAYER_WIDTH,
                    width: PLAYER_WIDTH,
                    height: PLAYER_HEIGHT,
                    x: (canvas.width / 2) - (PLAYER_WIDTH / 2),
                    y: (canvas.height / 2) - (PLAYER_HEIGHT / 2),
                    xAcceleration: 0,
                    yAcceleration: 0,
                    xVelocity: 0,
                    yVelocity: 0,
                    rotation: 0
                };
            }
            function makeAsteroid() {
                const side = randomboolean()
                const x = side ? randomchoice(-5,canvas.width+5) : randombetween(0,canvas.width);
                const y = side ? randombetween(0, canvas.height) : randomchoice(-5, canvas.height + 5);
                asteroids.push({
                    radius:randombetween(10,30),
                    x: x,
                    y: y,
                    xVelocity: x < 0 ? randombetween(8, 23) : randombetween(-23, -8),
                    yVelocity: y < 0 ? randombetween(8, 23) : randombetween(-23, -8),
                    isvisible: false
                });

            }

            function SpawnBullet(x,y,angle) {
                if (bullettimer <= 0){
                    bullettimer = 1
                bullets.push({
                 radius: (2),
                 x: x,
                 y: y,
                 xVelocity:  Math.sin(rad(angle))*200,
                 yVelocity:   Math.cos(rad(angle))*-200,
                })
                }
            }

            function spawnParticle(x,y,TTL) {
                particles.push({
                    x,
                    y,
                    TTL
                })
            }

            function updateParticles(){
                for(const particle of particles) {
                    particle.TTL -= DT
                }
                particles = particles.filter(P=>P.TTL > 0)
            }

            function rad(deg) {
                return deg * (Math.PI / 180);
            }
            function randombetween(min,max){
                return min+(Math.random()
                *(max-min))
            } 
            function randomboolean(){
                return Math.random()<= 0.5
            }
            function randomchoice(a,b){
                if (randomboolean()){
                    return a
                    
                }
                else return b
            }
            function distance(a,b){

             return Math.sqrt( Math.pow(a.y-b.y,2) + Math.pow(a.x-b.x,2))
                 
            }
            function intersects(a,b){
             return   distance(a,b) < a.radius+b.radius 
            }

        </script>
    </body>
</html>